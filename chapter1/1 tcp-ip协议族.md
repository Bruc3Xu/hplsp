## 1.1 tcp/ip协议族体系结构和主要协议
tcp/ip协议族是一个**分层、多协议**的通信体系。
### tcp发展
阿帕网arpanet，使用NCP网络控制协议进行不同计算机之间的通信。

1974 年发表了以**分组、序列化、流量控制、超时和容错**等为核心的一种新型的网络互联协议，一举奠定了 TCP/IP 协议的基础。

ISO定义了OSI 7层参考模型，但发布的时候TCP/IP协议已经成为主流（**时间上领先**）。

TCP/IP协议是免费或者少量收费的。UNIX系统的发展以及socket编程接口的快速推出，使得协议在实践中不断完善。

两种网络模型的对应关系：
| OSI参考模型 | TCP/IP协议栈 |
| --- | --- |
| 应用层 | 应用层（ping、telnet、OSPF、DNS） |
| 表示层 |  |
| 会话层 |  |
| 传输层 | 传输层（TCP/UDP） |
| 网络层 | 网际层（IPV4/V6） |
| 数据链路层 | 网络接口层 |
| 物理层 |  |

tcp/ip是4层协议，每一层通过若干协议来完成特定的功能，上一层使用下一层的服务，无需关心下一层的实现。
1. 应用层：**实现应用程序的逻辑**。ping程序, telnet, OSPF, DNS等协议, 作用于**用户空间**。
以下是内核空间，**用户空间与内核空间通过socket来交互**。
2. 传输层：**为应用层提供端到端的通信**。包含**TCP, UDP, SCTP**协议。负责数据的收发、超时重连等。
3. 网络层：**实现数据包的选路和转发**。WAN通过多级路由器连接主机和不同的局域网，两台主机连接需要经过多个中间路由器。网络层选择这些中间节点，确定两台主机之间的通信路径。对于tcp/ip协议上层而言，两台主机好像是直接连接的，无需关心二者之间的通信拓扑连接关系。包含**ICMP, IP协议**。IP协议选择路由和分发数据包，ICMP协议检测网络连接（Ping）。
4. 数据链路层：**实现了网卡接口的驱动程序**，向上隐藏了不同硬件的实现细节，提供统一的接口。包含**ARP（地址解析）, RARP（逆地址解析）, DataLink**等协议。网络层IP寻址，将IP地址通过ARP协议得到物理地址，数据链路层物理寻址。可以通过RARP协议将硬件地址转换为IP地址（运行RARP服务的管理者存有所有物理地址对应的IP地址）。

## 1.2 封装
上次协议通过封装来使用下层协议的功能。
```text
应用程序数据												TCP、UDP协议

TCP/UDP头部+应用程序数据
|--TCP报文段、UDP数据报--|                                 IP协议

IP头部+TCP/UDP头部+应用程序数据
|--------------- IP数据报--------------|                  以太网驱动程序

以太网头部   +   IP头部   +   TCP/UDP头部  + 应用程序数据  +  以太网尾部      
|------------------以太网帧--------------------------|
|目的地址6字节|源地址6字节|类型2字节|IP数据报46-1500字节|循环冗余校验CRC4字节|

```


帧的最大传输单元MTU，以太网帧1500字节，过大的IP数据包需要分片（fragment）。帧是物理网络上传输的真正字节序列。
## 1.3 分用demultiplexing
数据帧到达目的主机后，自底向上每一层处理对应的头部信息，最后将处理后的帧给到应用程序。分用是依靠头部信息中的类型字段实现的。
以太网帧2个字节用于类别IP、ARP和RARP，0x800对应IP协议，由IP模块处理。
IP数据报头部16位来区分TCP、UDP和ICMP。
TCP报文段和UDP数据报通过头部16位端口号来区分不同的应用程序。

## 1.5 ARP协议
arp请求和响应报文格式如下。
硬件类型：2字节，1表示mac地址。
协议类型：2字节，0x800表示IP地址。
硬件地址长度：1字节，mac地址是6.
协议地址长度：1字节。IPV4是4。
操作：2字节。1，2，3，4分别对应arp请求、应答和rarp请求、应答。
发送端以太网地址：6字节。
发送端IP地址：4字节。
目的端以太网地址：6字节。
目的端IP地址：4字节。

发送端发送arp请求，填充除了目的端以太网地址的其他字段，目的端接收到请求，填充其以太网地址，并将发送端和目的端地址调换，并将操作置为2。
## 1.6 DNS
分布式域名服务系统，将域名映射到IP地址。

## 1.7 socket与tcp/ip协议关系
socket是应用程序用来访问协议服务的api，有以下功能：
1. 将应用程序数据从用户缓冲区复制到TCP，UDP内核发送缓冲区，以交付内核来发送数据。反过来把TCP，UDP内核接收缓冲区复制到用户缓冲区。
2. 修改内核中各层协议的头部信息或者其他数据结构，进而精细控制底层通信行为。


### UNIX系统的发展
UNIX源代码不开源，POSIX（Portable Operating System Interface for ComputingSystems）这个标准基于现有的 UNIX 实践和经验，**描述了操作系统的调用服务接口**。有了这么一个标准，Linux 完全可以去实现并兼容它，这从最早的 Linux 内核头文件的注释可见一斑。

GNU-1984，自由软件基金会Free Software Foudation。推出了GCC，GDB，Bash Shell，Emacs。操作系统Hurd被放弃，转向Linux和FreeBSD。
